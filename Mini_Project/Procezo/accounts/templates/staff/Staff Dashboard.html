{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="author" content="Devika Sunilkumar" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="application-name" content="Procezo Website" />
    <meta name="language" content="English" />
    <title>{% block title %}Staff Dashboard{% endblock %}</title>
    <link rel="icon" type="image/x-icon" href="{% static 'image/procezo-title-logo.png' %}" />
    <link rel="stylesheet" href="{% static 'css/staff/StaffDashboard.css' %}" />
  </head>
  <body>
    <script type="text/javascript">
        function preventBack() {
            window.history.forward();
        }
        setTimeout("preventBack()", 0);
        window.onunload = function () { null };
    </script>    
    <!-- ================= aside ================= -->
    <aside id="home-page">
      <nav class="sidebar">
        <div class="top-section">
          <!-- Logo -->
          <img src="{% static 'image/procezo-logo-white.png' %}" alt="Procezo Logo" class="logo" />

          <!-- Profile Section -->
          <div class="profile-section">
            <div class="profile-left">
              <div class="profile-avatar">
                <img alt="profile" style="width: 60px; height: 60px;" src="{% static 'image/dashboard/' %}{% if staff.gender == 'female' %}female user.png{% else %}male user.png{% endif %}">
              </div>
            </div>

            <div class="profile-right">
              <div class="profile-staff-name">{{ staff.staff_id|default:"Staff ID" }}</div>
              <div class="profile-staff-role">{{ staff.role|default:"Role" }}</div>
              <div class="profile-job-type">{{ staff.job_type|default:"Job Type" }}</div>

              <a href="{% url 'accounts:staff_profile' %}">
                <button class="profile-update-btn">Update</button>
              </a>
            </div>
          </div>
          <ul class="menu">
            <li><a href="{% url 'accounts:staff_attendance' %}"><img src="{% static 'image/dashboard/Attendance.png' %}" alt="Attendance" class="icon" /><span>Attendance</span></a></li>
            <li><a href="{% url 'accounts:staff_work_schedule' %}"><img src="{% static 'image/dashboard/work schedule.png' %}" alt="Work Schedule" class="icon" /><span>Work Schedule</span></a></li>
            <li><a href="{% url 'accounts:staff_KeyLogs' %}"><img src="{% static 'image/dashboard/key logs.png' %}" alt="Key Logs" class="icon" /><span>Key Logs</span></a></li>
            <li><a href="{% url 'accounts:staff_emotion' %}"><img src="{% static 'image/dashboard/Emotion.png' %}" alt="Emotion" class="icon" /><span>Emotion</span></a></li>
            <!-- <li><a href="#"><img src="{% static 'image/dashboard/Salary.png' %}" alt="Salary" class="icon" /><span>Salary</span></a></li> -->
          </ul>
        </div>
    </aside>
    <!-- ================= main CONTENT ================= -->
    <div class="main-content">
      <header class="staff-header">
        <div class="left-box">
          <div class="title-row">
            <h1>Staff Dashboard <span class="role-tag">{{ staff.name|default:"Staff" }}</span></h2>
            <a href="{% url 'accounts:staff_dashboard' %}"><img src="{% static 'image/dashboard/AdminHome.png' %}" alt="search" class="home-icon" /></a>
            <!-- Camera Screen -->
            <div class="camera-screen">
              <header class="camera-header">
                <h1 id="camera-title" class="camera-title">Live Camera</h1>
                <div class="live-indicator"><span class="live-dot"></span> <span class="live-text">Live</span>
                </div>
              </header>
              <div class="camera-viewport">
                  <video id="camera-video" autoplay playsinline muted></video>
                  <div id="camera-error" class="camera-error" style="display: none;">
                      <svg class="error-icon" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 9V11M12 15H12.01M5.07 19H18.93C20.14 19 21 17.94 20.49 16.86L13.56 4.14C13.05 3.06 11.95 3.06 11.44 4.14L4.51 16.86C4 17.94 4.86 19 5.07 19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                      <p class="error-text">Camera access denied or unavailable</p><button id="retry-button" class="retry-button">Retry</button>
                  </div>
                  <div class="scan-line"></div>
                  <div class="corner-bracket top-left"></div>
                  <div class="corner-bracket top-right"></div>
                  <div class="corner-bracket bottom-left"></div>
                  <div class="corner-bracket bottom-right"></div>
                  <div class="camera-focus"></div>
                  <div class="camera-timestamp" id="timestamp">
                      </div>
                  <button id="camera-toggle" class="camera-toggle" aria-label="Toggle camera">
                      <svg class="toggle-icon" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M23 7L16 12L23 17V7Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="currentColor" /> <rect x="1" y="5" width="18" height="17" rx="2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                      <span id="toggle-text">ON</span> 
                  </button>             
                  <canvas id="emotion-canvas" style="display: none;"></canvas>  
              </div>
            </div>              
          </div>         
        </div>
        
        <button class="logout-btn" id="logout-button" data-logout-url="{% url 'accounts:api_face_logout' %}" data-login-url="{% url 'accounts:login_register' %}" onclick="handleCheckOut()">
          <div class="sign">
            <svg viewBox="0 0 512 512">
              <path d="M377.9 105.9L500.7 228.7c7.2 7.2 11.3 17.1 11.3 27.3s-4.1 20.1-11.3 27.3L377.9 406.1c-6.4 6.4-15 9.9-24 9.9c-18.7 0-33.9-15.2-33.9-33.9l0-62.1-128 0c-17.7 0-32-14.3-32-32l0-64c0-17.7 14.3-32 32-32l128 0 0-62.1c0-18.7 15.2-33.9 33.9-33.9c9 0 17.6 3.6 24 9.9zM160 96L96 96c-17.7 0-32 14.3-32 32l0 256c0 17.7 14.3 32 32 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-64 0c-53 0-96-43-96-96L0 128C0 75 43 32 96 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32z"/>
            </svg>
          </div>
          <div class="logout-btn-text">Logout</div>
        </button>

        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
        <input type="hidden" id="userEmail" value="{{ staff.email|default:'' }}">
      </header>
      
      {% block content %}
      <!-- ====== Stats Grid ====== -->
      <div class="stats-grid">
        <div class="stat-card" id="statCard1">
          <div class="stat-icon" id="statIcon1">‚úÖ</div>
          <div class="stat-value" id="statValue1">{{ stats.tasks_completed }}</div>
          <div class="stat-label" id="statLabel1">Tasks Completed</div>
        </div>

        <div class="stat-card" id="statCard2">
          <div class="stat-icon" id="statIcon2">‚è∞</div>
          <div class="stat-value" id="statValue2">{{ stats.tasks_pending }}</div>
          <div class="stat-label" id="statLabel2">Pending Tasks</div>
        </div>

        <div class="stat-card" id="statCard3">
          <div class="stat-icon" id="statIcon3">üìÖ</div>
          <div class="stat-value" id="statValue3">{{ todays_meet_count }}</div>
          <div class="stat-label" id="statLabel3">Meetings Today</div>
        </div>

        <div class="stat-card" id="statCard4">
          <div class="stat-icon" id="statIcon4">üéÇ</div>
          <div class="stat-value" id="statValue4">{{ birthday_this_week_count }}</div>
          <div class="stat-label" id="statLabel4">Birthdays This Week</div>
        </div>
      </div>

      <!-- ====== Content 2 Column Layout ====== -->
      <div class="content-grid">
        <div class="content-grid-card" id="tasksCard">
          <div class="card-header">
            <h2 id="tasksTitle">Today's Tasks</h2>
            <button class="view-all" id="viewAllTasks">
                <a href="{% url 'accounts:staff_work_schedule' %}">View All</a>
            </button>
          </div>

          <div class="tasks-container">
            {% for task in tasks %}
            <div class="task-item">
              <div class="task-checkbox" data-id="{{ task.schedule_id }}"></div>
              <div class="task-content">
                <div class="task-title">{{ task.description }}</div>
                <div class="task-time">Due: {{ task.start_time|date:"h:i A" }}</div>
              </div>
            </div>
            {% empty %}
            <div class="task-item">
              <div class="task-content">
                <div class="task-title" style="color: gray;">No tasks assigned for today.</div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- Announcements Card -->
        <div class="content-grid-card" id="announcementsCard">
          <div class="card-header">
              <h2 id="announcementsTitle">üéÇ Upcoming Birthdays</h2>
          </div>

          <div class="birthday-list">
              {% for b in upcoming_birthdays %}
              <div class="birthday-item">
                  <div class="birthday-avatar">
                      {{ b.name|slice:":1" }}{{ b.name|slice:"1:2" }}
                  </div>

                  <div class="birthday-info">
                      <p class="birthday-name">{{ b.name }}</p>

                      {% if b.dob.month == today.month and b.dob.day == today.day %}
                          <p class="birthday-date">Today - {{ b.dob|date:"M d" }}</p>
                      {% elif b.dob.month == tomorrow.month and b.dob.day == tomorrow.day %}
                          <p class="birthday-date">Tomorrow - {{ b.dob|date:"M d" }}</p>
                      {% else %}
                          <p class="birthday-date">{{ b.dob|date:"M d" }}</p>
                      {% endif %}
                  </div>

                  <div class="birthday-icon">üéâ</div>
              </div>
              {% empty %}
              <p style="padding: 20px;">No upcoming birthdays üéà</p>
              {% endfor %}
          </div>
        </div>

        <!-- ====== Schedule ====== -->
        <div class="schedule-card">
            <div class="schedule-header">
                <h2>Today's Schedule</h2>
                <a href="https://calendar.google.com" target="_blank" class="view-btn">
                    View Calendar
                </a>
            </div>

            <div class="schedule-grid">
                {% if todays_meets %}
                    {% for meet in todays_meets %}
                    <div class="schedule-item">
                        <div class="schedule-time">
                            {{ meet.meet_time|date:"g:i A" }}
                        </div>
                        <div class="schedule-divider"></div>
                        <div class="schedule-details">
                            <h4>{{ meet.meet_title }}</h4>
                            <p>{{ meet.meet_description }}</p>
                            {% if meet.meet_link %}
                                <a href="{{ meet.meet_link }}" class="meet-link" target="_blank">
                                    üìπ Join Google Meet
                                </a>
                            {% else %}
                                <span class="no-link">No meeting link</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="padding: 15px;">No meetings scheduled for today.</p>
                {% endif %}
            </div>
        </div>
      </div>
      <script src="{% static 'js/staff/StaffDashboard.js' %}"></script>
      {% endblock %}
    </div>       
  </body>
</html>